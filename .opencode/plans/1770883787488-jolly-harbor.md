# Plan: Add Composition + React Query Docs (client/)

## Goal
Integrate the provided **Hybrid React Composition Architecture** reference into this repo’s **client documentation** at `client/`, producing markdown docs that:

- capture the mental model: **Coordinate high. Fetch low. Render dumb.**
- explain how/where **TanStack Query (React Query)** should live (colocated near usage)
- map cleanly onto the existing documented feature/module structure (features/hooks/helpers/components)
- stay consistent with existing client docs (and resolve the most confusing contradictions where necessary)

## What I Found In The Repo (client/)

- `client/` contains documentation + skills only (no actual TS/TSX implementation).
- The architecture is already mostly described across multiple docs:
  - Business vs presentation split: `client/core/conventions.md`, `client/core/ui-patterns.md`, `client/references/05-component-separation.md`
  - TanStack Query + tRPC patterns: `client/core/data-fetching.md`, `client/references/03-tanstack-query-trpc.md`
  - State decision flow (Query vs RHF vs nuqs vs Zustand): `client/core/state-management.md`
- There are a few doc inconsistencies that will collide with the new composition doc unless addressed:
  - `client/nextjs/overview.md` says “Avoid `useTRPC` / `queryOptions` / `mutationOptions`”, but many core/reference docs use them.
  - `client/nextjs/overview.md` points provider wiring at `src/components/providers.tsx`, but core docs use `src/common/providers/trpc-provider.tsx`.

## Deliverables (Recommended)

### 1) New core doc: composition + server state
Add a new core markdown that consolidates the pattern into one place and adapts it to our conventions.

Proposed path (subject to naming choice):

- `client/core/composition.md`

Doc outline:

- Philosophy + explicit definition of the 3 layers in *this repo’s terms*:
  - Provider layer: app coordination + infra only (no server data fetching)
  - Business layer: feature components + (optional) feature hooks; React Query lives here
  - Presentation layer: dumb views/fields/cards/lists (no fetching, no orchestration)
- The “colocation ladder” for React Query:
  - Default: colocate `trpc.*.useQuery/useMutation` in the smallest business component that needs it
  - Extract into `src/features/<feature>/hooks.ts` only for reuse / readability
  - Move shaping/transforms into `src/features/<feature>/helpers.ts` and call via React Query `select`
- Mapping to the documented feature module layout (`src/features/<feature>/...`) + examples using existing conventions (ProfileForm/fields style)
- Composition patterns that prevent “god components”:
  - screen coordinator component + leaf business sections
  - “domain hook” (`use<Feature>Model`) to avoid hook spaghetti
- Heuristics + anti-patterns (mega providers, smart views, lifting server state too high)
- Testing approach (fixtures for views; mock hooks for business components)

Planned sections for `client/core/composition.md`:

- **Core Philosophy** (include the motto, and define “fetch low” as “in business layer, not presentation”)
- **Layer Boundaries** (Providers vs Business vs Presentation, with do/don’t lists)
- **React Query Colocation** (benefits + how it reduces re-render scope)
- **Colocation Ladder** (inline query → feature hook → helpers/select → shared client)
- **Mapping to Feature Modules** (table mapping responsibilities → file locations already used in this repo)
- **Patterns/Recipes** (screen coordinator + leaf sections; domain hook; slot-based composition)
- **TanStack Query Notes** (select/enabled/invalidation; tRPC hooks vs advanced TanStack usage)
- **Anti-patterns** (mega providers, smart views, lifting server state high, duplicating server data in Zustand)
- **Testing & Fixtures** (unit-test presentation; mock hooks for business components)
- **Checklist** (copy/paste)

### 2) Link it from the main client entrypoints
Update:

- `client/README.md` (Core Documentation table)
- `client/core/overview.md` (add to index / quick ref)

### 3) Fix the most confusing contradictions (requested)
Update `client/nextjs/overview.md` to:

- Align provider wiring path with core docs (`src/common/providers/trpc-provider.tsx`)
- Replace the strict “Avoid …” guidance with tiered guidance consistent with `client/core/data-fetching.md`:
  - Default to `trpc.*.useQuery/useMutation` + `trpc.useUtils()` for invalidation
  - Allow `useTRPC()` + `queryOptions/mutationOptions/queryFilter/queryKey` when you need TanStack primitives (prefetching, optimistic updates, `useMutation` customization)

## Files To Change

- Add: `client/core/composition.md`
- Update: `client/README.md`
- Update: `client/core/overview.md`
- Update: `client/nextjs/overview.md`

## Verification

- Ensure all new links resolve (no broken relative links from `client/README.md` and `client/core/overview.md`).
- Quick read-through for consistency with:
  - `client/core/conventions.md`
  - `client/core/data-fetching.md`
  - `client/core/state-management.md`
- Grep check after edits: no remaining “Avoid `useTRPC` …” contradiction in `client/nextjs/overview.md`.

If we can run a quick automated check in build phase:

- `rg "\(\./core/composition\.md\)" client/README.md` shows the new index link
- `rg "Composition" client/core/overview.md` shows the new entry
- `rg "Avoid `useTRPC`" client/nextjs/overview.md` returns no matches

## Concrete Edit Notes (for execution)

- `client/README.md`: add `Composition` row to the Core Documentation table.
- `client/core/overview.md`: add `Composition` row to the Documentation Index table; optionally add the motto to the Core Principles table.
- `client/nextjs/overview.md`:
  - Update provider wiring path (`src/common/providers/trpc-provider.tsx`).
  - Replace the “Avoid …” bullet with the tiered guidance block.

## Non-Goals (this pass)

- No refactors of the large reference docs under `client/references/`.
- No attempt to fully reconcile every file-path convention across server/client docs; only fix the contradictions that would directly confuse the React Query composition guidance.
